<html>
    <head>
        <title>Visualization</title>

        <link rel="stylesheet" type="text/css" href="../css/styles.css">
        <script src="https://d3js.org/d3.v7.min.js"></script>
    </head>
    <body>
        <!-- First Visualization: Chord Diagram -->
        <!--<h1>Chord Graph Example</h1> -->
    <div class = "banner" height = "100%"  width ="100%">
        <h1 class = "title ">MIGRATION VISUALIZATION </h1>
        <h1 class = "title "> Migration Visualization</h1>
        <h1 class = "title "></h1>
    </div>
    <div class = "main"  width ="100%">
        <svg id="chord" height="800" width="800" ></svg>
        <svg id="spider" height="700" width="600"></svg>
    </div>

    <div id = 'bar-container'>
        <svg id='bar' height = "300" width = '650'></svg>
        <svg id='bar2' height = "300" width = '650'></svg>
    </div>

    <style> 

    body {
        background-color: rgb(234, 230, 222);
        text-align: center;
   
    }

    .title {
        color: rgb(44, 69, 97);
        stroke-width: 3;
        font-size: 60;
        font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
        font-style: oblique;
    }

    .banner {
        margin-top: 15%;
        margin-bottom: 10%;
    }

    .sub-title {
        font-family:'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
        color: rgb(44, 69, 97)
        }
    
    .column {
        flex-direction: column;
        display: flex;
    }
    
    .button {
    
        color: rgb(252, 252, 252);
        border: 2px ;
        border-radius: 8px;
        width: 100;
        height: 40;
        cursor: pointer;
}

    .chord-label {
        font-size: 10;
    }

   
 
        
    


    </style>


        <script>
            const chordsvg = d3.select("#chord");
            const width = chordsvg.attr("width");
            const height = chordsvg.attr("height");
            const chordChart = chordsvg.append("g");
            
            const drawChord = async () => {
            const colorPalette = ["#48bf8e", "#075c62", "#a1def0", "#5e2a96", 
                                    "#e775cc", "#f3c5fa", "#9a76af", "#1c4585", 
                                    "#479abc", "#94ea5b", "#1d6d1f", "#cddb9b", 
                                    "#604020", "#d48f4d", "#f24219", "#8e1023", 
                                    "#8c956d", "#2cf52b", "#ff0087", "#e9d737"]
          
              const edges_ds = await d3.json("edges_new.json");
              const nodes_ds = await d3.json("nodes_new.json");

              let links = edges_ds;
              let nodes = nodes_ds;
              console.log("links",links);
              console.log("nodes",nodes);

              let matrix = [];
              let connections = {}; 
              for (let i=0; i< Object.keys(nodes).length; i++) {
                  let row = [];
                  for (let j=0; j< Object.keys(nodes).length; j++) {row.push(0);}
                  matrix.push(row);
                  connections[i] = [i]; 
              }
              console.log("matrix", matrix);

              Object.values(links).forEach( d => {
                if (d.Weight > 0) {
                      matrix[d.Source][d.Target] = d.Weight;
                      matrix[d.Target][d.Source] = d.Weight;
                      connections[d.Source].push(d.Target);
                      connections[d.Target].push(d.Source);
                }
              });
              console.log("connections", connections);

              let radius = (width / 2.0) - 125;
              // Draw chord
              let chordGen = d3.chord()
                    .padAngle(.04)
                    .sortSubgroups(d3.descending)
                    .sortChords(d3.descending);

              // Thickness of container
              let arcGen = d3.arc()
                    .innerRadius(radius)
                    .outerRadius(radius + 15);
              let ribbonGen = d3.ribbon()
                      .radius(radius);
              let chords = chordGen(matrix);

              chordChart.attr("transform",`translate(${width/2.0},${height/2.0})`);
              let colorScale = d3.scaleOrdinal().range(colorPalette);

              // Circular Container
              let ringContainer = chordChart.append("g");
              let rings = ringContainer.selectAll("g.segment")
                            .data(chords.groups)
                            .join("g")
                            .attr("class","segment");

              // Mouse OVER
              function onMouseOver(selected) {
                  console.log(selected)
                  ribbons.filter( d => nodes[d.index] !== selected.index)
                       .style("opacity", 0.3);

                  chordsvg.selectAll(".ribbon")
                       .filter( d => nodes[d.source.index] !== selected.index)
                       .style("opacity", 0.3);
              }
              // Mouse OUT
              function onMouseOut() {
                  ribbons.style("opacity", 1);

                  chordsvg.selectAll(".ribbon")
                          .style("opacity", 1);
              }
            
              rings.append("path")
                   .attr("fill", d => colorScale( nodes[ d.index ].SubContinent ))
                   .attr("fill", function (d) {
                    if (nodes[d.index].SubContinent == 'North America'   ){
                       return ('orange');//colorScale( nodes[ d.index ].SubContinent );
                     }
                     if (nodes[d.index].SubContinent == 'East Asia'   ){
                       return ("purple");//colorScale( nodes[ d.index ].SubContinent// );
                     }

                     else {return 'gray'}
                   })
                   //.attr("stroke", d => colorScale( nodes[ d.index ].SubContinent ))
                   .attr("d", arcGen);

              // Ribbons
              let ribbonContainer = chordChart.append("g");
              let ribbons = ribbonContainer.selectAll("path.ribbon")
                      .data(chords)
                      .join("path")
                      .attr("class","ribbon")
                      .attr("fill-opacity", 0.5)
                      .attr("stroke", "none")
                      .attr("fill", function (d) {
                        if (nodes[d.source.index].SubContinent == 'North America'  ){
                            return "orange"//colorScale( nodes[ d.source.index ].SubContinent );
                        }
                        if (nodes[d.source.index].SubContinent == 'East Asia'   ){
                            return "purple";//colorScale( nodes[ d.source.index ].SubContinent );
                        }
                        else {return 'gray'}
                        })
                      .attr("d", ribbonGen)
                      .on("mouseover", d => onMouseOver(d.source))
                      .on("mouseout", d => onMouseOut(d.source));
                    //   .attr("cursor", function (d) {
                    //     if (nodes[d.source.index].SubContinent == 'North America'  )
                    //     {return 'pointer'}
                    //     if (nodes[d.source.index].SubContinent == 'East Asia'  )
                    //     {return 'pointer'}
                    //   });
                      //"pointer");

              // Label the Subcontinents
              chords.groups.forEach(d =>{
                  let transform = '';
                  // find midpoint, convert to degrees
                  let midpoint = (d.startAngle + d.endAngle) / 2;
                  let rotation = ( midpoint ) * ( 180 / Math.PI ) - 90;
                  //2PI*unit radius = 360, PI*unit = 180
                  transform = transform + ` rotate(${rotation})`;
                  transform = transform + ` translate(${radius+25}, 0)`;
                  d.anchor = 'middle'
                  //if (rotation > 90) {
                      transform = transform + ' rotate(90)';
                      // Notice text anchor issue that also first
                      d.anchor = "middle";
                 // }
                  d.trans = transform;
              });
              

              rings.append('text')
                   .attr('transform', d=> d.trans)
                   .text(d => nodes[d.index].SubContinent)
                   .attr('text-anchor', d => d.anchor)
                   .attr('class','chord-label');
                //    .attr('fill', d => colorScale( nodes[ d.index ].Continent ));
            }
            drawChord();
        </script>

        <!-- Second Visualization: Spider Diagram -->
       <!---<h1>Spider Diagram</h1> -->
        <p id = 'spider-chart'>
        <div class = "column">
            <div id="send-bar">
                <h3 class = 'sub-title'>Sending Country:</h3>
            </div>
            <div id="receive-bar">
                <h3 class = 'sub-title'>Receiving Country:</h3>
            </div>
        
        </div>
            

            
            <script>
            
            const features = ["Healthcare Access and Quality Index","Annual CO2 Emission","Civil Liberty"];
            const units = [' ','Tonnes Per Capita',' ']
            const country_names = ['China','Japan','South Korea','North Korea','Taiwan','Mongolia',"United States",'Canada']
            const country_colors = ['#5E1240','#3A394E','#E16425','#033148','#0D6D76','#C88477','#E6484B','#9292C2']


            let spider_colorScale = d3.scaleOrdinal()
                                .domain([country_names])
                                .range(country_colors);


            
            country_data = {
            'China': {'Healthcare Access and Quality Index': 6.2, 'Annual CO2 Emission': 0.7257151269449413, 'Civil Liberty': 4},
            'Japan': {'Healthcare Access and Quality Index': 9.02, 'Annual CO2 Emission': 3.918873009761511, 'Civil Liberty': 8},
            'South Korea': {'Healthcare Access and Quality Index': 8.3, 'Annual CO2 Emission': 4.033474509093379, 'Civil Liberty': 8},
            'North Korea': {'Healthcare Access and Quality Index': 4.78, 'Annual CO2 Emission': 0.0, 'Civil Liberty': 3}, 
            'Taiwan': {'Healthcare Access and Quality Index': 7.8, 'Annual CO2 Emission': 4.87011075125133, 'Civil Liberty': 9}, 
            'Mongolia': {'Healthcare Access and Quality Index': 4.72, 'Annual CO2 Emission': 0.1468756369895592, 'Civil Liberty': 8}, 
            'United States': {'Healthcare Access and Quality Index': 8.73, 'Annual CO2 Emission': 10.0, 'Civil Liberty': 9},
            'Canada': {'Healthcare Access and Quality Index': 9.12, 'Annual CO2 Emission': 8.362568794872375, 'Civil Liberty': 9} }
            console.log(country_data)
            
            allKeys = Object.keys(country_data);
            console.log("allkeys", allKeys);
            allValues = Object.values(country_data);
            console.log("allvalues", allValues);
                            
            const svg = d3.select("svg#spider");
            const spider_width = svg.attr("width");
            const spider_height = svg.attr("height");
            
            let spiderChart = svg.append("g").attr("id","diagrams");
            let annotations = svg.append("g").attr("id","annotations");
            
            let radialScale = d3.scaleLinear()
                .domain([0,10])
                .range([0,200]);
            let ticks = [2,4,6,8,10];
            
            ticks.forEach(t =>
                annotations.append("circle")
                .attr("cx", 300)
                .attr("cy", 350)
                .attr("fill", "none")
                .attr("stroke", "lightgray")
                .attr("r", radialScale(t))
            );
            
            function angleToCoordinate(angle, value){
                let x = Math.cos(angle) * radialScale(value);
                let y = Math.sin(angle) * radialScale(value);
                return {"x": 300 + x, "y": 350 - y};
            }
            
            for (var i = 0; i < features.length; i++) {
                console.log(i);
                let ft_name = features[i];
                let angle = (Math.PI / 2) + (2 * Math.PI * i / features.length);
                let line_coordinate = angleToCoordinate(angle, 10);
                let label_coordinate = angleToCoordinate(angle, 11.6);
                console.log(line_coordinate);


                let transform = ''  
                let midpoint = (angle) / 2;
                let rotation = ( midpoint ) * ( 180 / Math.PI ) ;
                transform = transform + ` rotate(${rotation})`;
                transform = transform + ` translate(${300}, 0)`;

                


            //     chords.groups.forEach(d =>{
            //       let transform = '';
            //       // find midpoint, convert to degrees
            //       let midpoint = (d.startAngle + d.endAngle) / 2;
            //       let rotation = ( midpoint ) * ( 180 / Math.PI ) - 90;
            //       //2PI*unit radius = 360, PI*unit = 180
            //       transform = transform + ` rotate(${rotation})`;
            //       transform = transform + ` translate(${radius+25}, 0)`;
            //       d.anchor = 'middle'
            //       //if (rotation > 90) {
            //           transform = transform + ' rotate(90)';
            //           // Notice text anchor issue that also first
            //           d.anchor = "middle";
            //      // }
            //       d.trans = transform;
            //   });
            
                //draw axis line
                annotations.append("line")
                .attr("x1", 300)
                .attr("y1", 350)
                .attr("x2", line_coordinate.x)
                .attr("y2", line_coordinate.y)
                .attr("stroke","lightgray");
            
                //draw axis label
                annotations.append("text")
                .attr("x", label_coordinate.x)
                .attr("y", line_coordinate.y)
                .attr("transform", transform.ft_name)
                .text(ft_name)
                
                .attr("fill","gray");

            }


    
            
            allKeys.forEach( d => {
            
            d3.select("div#send-bar")
              .append("button")
              .text(d)
              .style ("display" , "inline-block")
              .style("margin","4")
              .style ("background-color",spider_colorScale(d))
              .attr("class", "button")

            
              .on('click', function(){
                updateSend(d); 
            
              }) 
            
            
              d3.select("div#receive-bar")
              .append("button")
              .text(d)
              .style("margin","4")
              .style ("background-color",spider_colorScale(d))
              .attr("class", "button")
              .on('click', function(){
                updateReceive(d);
            
              })
            
            
            });
            
            tri_send = spiderChart.append("path")
                             .attr("stroke-width", 3)
                             .attr("stroke-opacity", 1)
                             .attr("opacity", 0.7);
            
            tri_receive = spiderChart.append("path")
                             .attr("stroke-width", 3)
                             .attr("stroke-opacity", 1)
                             .attr("opacity", 0.7);
            

            console.log("spider_colorScale", spider_colorScale);   
            

        //Bar Plot canvas
        const svgBar = d3.select("svg#bar")

        let diagrams =  svgBar.append('g').attr('id','bar_diagrams');

        const bar_width = 600;
        const bar_height = 200;
        console.log(bar_width);

        var x = d3.scaleLinear().domain([0,10]).range([0,bar_width]);

        var y = d3.scaleBand()
                  .range([ 0, 200 ])
                  .domain(features)
                  .padding(.3);

        const svgBar2 = d3.select("svg#bar2")
        let diagrams2 =  svgBar2.append('g').attr('id','bar_diagrams2');

        const bar2_width = 600;
        const bar2_height = 200;

            
            
        function updateSend (countryKey) {
        const data = country_data[countryKey];
        
        console.log("data",data)
            
        
        let line = d3.line()
            .x(d => d.x)
            .y(d => d.y);
        
        
        function getPathCoordinates(data_point){
        let coordinates = [];
            for (var i = 0; i < features.length; i++){
                let ft_name = features[i];
            
                let angle = (Math.PI /2) + (2 * Math.PI * i / features.length);
                coordinates.push(angleToCoordinate(angle, data_point[ft_name]));
            }
            return coordinates;
        }
        
            let d = data;
            console.log("d",d);
            
            
            let coordinates = getPathCoordinates(d);
            console.log("coordinates", coordinates);
            
            //draw the path element
            tri_send.datum(coordinates)  
                .transition()
                .attr("d", line) 
                .attr("stroke", spider_colorScale(countryKey))
                .attr("fill", spider_colorScale(countryKey))  
                            
        

        for (var i=0; i<features.length;i++){
            let ft_name = features[i];
            let unit = units[i]
            console.log(ft_name)
            console.log(d[ft_name])
            diagrams.append('rect')
                .attr('id','default_bar')
                .attr('x',0)
                .attr('y',y(ft_name))
                .attr('width',550)
                .attr('height',y.bandwidth())
                .attr('fill','rgb(187, 187, 187)')
                .attr('rx','5')


            diagrams.append('rect')
                .attr('x',550-x(d[ft_name]))
                .attr('y',y(ft_name))
                .attr('width',x(d[ft_name]))
                .attr('height',y.bandwidth())
                .attr('fill',spider_colorScale(countryKey))
                .attr('rx','5')
            if ((ft_name) == 'Annual CO2 Emission'){
            diagrams.append('text')
                    .text(d[ft_name].toFixed(2) + ' ' +unit)
                    .attr('x',470)
                    .attr('y',y(ft_name)+y.bandwidth()/2*1.4)
                    .attr('fill','white')
                    .attr("text-anchor", "start")
                    .attr("font-family", "sans-serif")
                    .attr("font-size", "25px")
            }else{
            diagrams.append('text')
                    .text(d[ft_name].toFixed(2) + ' ' +unit)
                    .attr('x',680)
                    .attr('y',y(ft_name)+y.bandwidth()/2*1.4)
                    .attr('fill','white')
                    .attr("text-anchor", "start")
                    .attr("font-family", "sans-serif")
                    .attr("font-size", "25px")
            }


        }


    }


            
            function updateReceive (countryKey) {
                const data = country_data[countryKey];
            
                    console.log("data",data)
        
            let line = d3.line()
                .x(d => d.x)
                .y(d => d.y);
            
            function getPathCoordinates(data_point){
            let coordinates = [];
                for (var i = 0; i < features.length; i++){
                    let ft_name = features[i];
                
                    let angle = (Math.PI /2) + (2 * Math.PI * i / features.length);
                    coordinates.push(angleToCoordinate(angle, data_point[ft_name]));
                }
                return coordinates;
            }
            
                let d = data;
                console.log("d",d);
                
                
                let coordinates = getPathCoordinates(d);
                console.log("coordinates", coordinates);
                
            
            
                //draw the path element
                tri_receive.datum(coordinates)  
                    .transition()
                    .attr("d", line) 
                    .attr("stroke", spider_colorScale(countryKey))
                    .attr("fill", spider_colorScale(countryKey))    
                    
                              //draw bar Plot
               for (var i=0; i<features.length;i++){
                 let ft_name = features[i];
                 let unit = units[i]
                 console.log(ft_name)
                 console.log(d[ft_name])
                 diagrams2.append('rect')
                       .attr('id','default_bar')
                       .attr('x',0)
                       .attr('y',y(ft_name))
                       .attr('width',750)
                       .attr('height',y.bandwidth())
                       .attr('fill','rgb(187, 187, 187)')
                       .attr('rx','5')


                 diagrams2.append('rect')
                       .attr('x',0)
                       .attr('y',y(ft_name))
                       .attr('width',x(d[ft_name]))
                       .attr('height',y.bandwidth())
                       .attr('fill',spider_colorScale(countryKey))
                       .attr('rx','5')
                diagrams2.append('text')
                       .text(ft_name.toUpperCase()+' : ' + d[ft_name].toFixed(2) + ' ' +unit)
                       .attr('x',5)
                       .attr('y',y(ft_name)+y.bandwidth()/2*1.4)
                       .attr('fill','white')
                       .attr("text-anchor", "start")
                       .attr("font-family", "sans-serif")
                       .attr("font-size", "25px")
               }
              
            
            }
            </script>
        </p>
    </body>
</html>